#*****************************************************************************************
# Vivado project creation script for {{ project_name }}
#
# Generated by vivado-setup
#
# Usage: vivado -source create_project.tcl
#*****************************************************************************************

# Set the reference directory for source file relative paths
set origin_dir "."

# Set the project name
set _xil_proj_name_ "{{ project_name }}"

# Use project name variable, if specified in the tcl shell
if { [info exists ::user_project_name] } {
  set _xil_proj_name_ $::user_project_name
}

# Create project
create_project ${_xil_proj_name_} ./${_xil_proj_name_} -part {{ part }}

# Set the directory path for the new project
set proj_dir [get_property directory [current_project]]

# Set project properties
set obj [current_project]
# Board part may not be installed - skip if unavailable
catch {set_property -name "board_part" -value "{{ board_part }}" -objects $obj}
set_property -name "default_lib" -value "xil_defaultlib" -objects $obj
set_property -name "enable_vhdl_2008" -value "1" -objects $obj
set_property -name "ip_cache_permissions" -value "read write" -objects $obj
set_property -name "ip_output_repo" -value "$proj_dir/${_xil_proj_name_}.cache/ip" -objects $obj
set_property -name "mem.enable_memory_map_generation" -value "1" -objects $obj
set_property -name "revised_directory_structure" -value "1" -objects $obj
set_property -name "sim.central_dir" -value "$proj_dir/${_xil_proj_name_}.ip_user_files" -objects $obj
set_property -name "simulator_language" -value "Mixed" -objects $obj

# Create 'sources_1' fileset (if not found)
if {[string equal [get_filesets -quiet sources_1] ""]} {
  create_fileset -srcset sources_1
}

# Set 'sources_1' fileset object
set obj [get_filesets sources_1]

{% if ext_f %}
# Add registers.svh as a global include header (required by fpnew)
set header_file [file normalize "${origin_dir}/../../../svc/external/fpnew/src/common_cells/include/common_cells/registers.svh"]
add_files -norecurse -fileset $obj $header_file
set file_obj [get_files -of_objects [get_filesets sources_1] [list "*$header_file"]]
set_property -name "file_type" -value "Verilog Header" -objects $file_obj
set_property -name "is_global_include" -value "1" -objects $file_obj

# fpnew SystemVerilog files (packages must be compiled before modules that import them)
set sv_files [list \
{% for f in fpnew_sv_files %}
 [file normalize "${origin_dir}/{{ f }}"] \
{% endfor %}
 [file normalize "${origin_dir}/../rtl/top.sv"] \
]

# T-Head E906 vendor Verilog files (for TH32 divsqrt)
set v_files [list \
{% for f in fpnew_v_files %}
 [file normalize "${origin_dir}/{{ f }}"] \
{% endfor %}
]

add_files -norecurse -fileset $obj $sv_files
add_files -norecurse -fileset $obj $v_files

# Set file type for SystemVerilog files and force enabled
foreach f $sv_files {
  set file_obj [get_files -of_objects [get_filesets sources_1] [list "*$f"]]
  set_property -name "file_type" -value "SystemVerilog" -objects $file_obj
  set_property -name "is_enabled" -value "1" -objects $file_obj
}

# Set file type for Verilog files and force enabled
foreach f $v_files {
  set file_obj [get_files -of_objects [get_filesets sources_1] [list "*$f"]]
  set_property -name "file_type" -value "Verilog" -objects $file_obj
  set_property -name "is_enabled" -value "1" -objects $file_obj
}

# Force compile order update and disable auto-compile order
update_compile_order -fileset sources_1
set_property -name "source_mgmt_mode" -value "DisplayOnly" -objects [current_project]
{% else %}
set files [list \
 [file normalize "${origin_dir}/../rtl/top.sv"] \
]
add_files -norecurse -fileset $obj $files

# Set 'sources_1' fileset file properties for remote files
set file "$origin_dir/../rtl/top.sv"
set file [file normalize $file]
set file_obj [get_files -of_objects [get_filesets sources_1] [list "*$file"]]
set_property -name "file_type" -value "SystemVerilog" -objects $file_obj
{% endif %}

# Set 'sources_1' fileset properties
set obj [get_filesets sources_1]
set_property -name "include_dirs" -value "{{ include_dirs }}" -objects $obj
{% if ext_f %}
set_property -name "verilog_define" -value "EXT_F=1" -objects $obj
{% endif %}
set_property -name "top" -value "top" -objects $obj
set_property -name "top_auto_set" -value "0" -objects $obj

# Create 'constrs_1' fileset (if not found)
if {[string equal [get_filesets -quiet constrs_1] ""]} {
  create_fileset -constrset constrs_1
}

# Set 'constrs_1' fileset object
set obj [get_filesets constrs_1]

# Add/Import constrs file and set constrs file properties
set file "[file normalize "$origin_dir/../constraints/{{ constraints_file }}"]"
set file_added [add_files -norecurse -fileset $obj [list $file]]
set file "$origin_dir/../constraints/{{ constraints_file }}"
set file [file normalize $file]
set file_obj [get_files -of_objects [get_filesets constrs_1] [list "*$file"]]
set_property -name "file_type" -value "XDC" -objects $file_obj

# Create 'sim_1' fileset (if not found)
if {[string equal [get_filesets -quiet sim_1] ""]} {
  create_fileset -simset sim_1
}

# Set 'sim_1' fileset object
set obj [get_filesets sim_1]

# Set 'sim_1' fileset properties
set obj [get_filesets sim_1]
set_property -name "top" -value "top" -objects $obj
set_property -name "top_auto_set" -value "0" -objects $obj
set_property -name "top_lib" -value "xil_defaultlib" -objects $obj

# Create 'synth_1' run (if not found)
if {[string equal [get_runs -quiet synth_1] ""]} {
    create_run -name synth_1 -part {{ part }} -flow {Vivado Synthesis 2024} -strategy "Vivado Synthesis Defaults" -report_strategy {No Reports} -constrset constrs_1
} else {
  set_property strategy "Vivado Synthesis Defaults" [get_runs synth_1]
  set_property flow "Vivado Synthesis 2024" [get_runs synth_1]
}
set obj [get_runs synth_1]
set_property -name "auto_incremental_checkpoint" -value "1" -objects $obj
set_property -name "strategy" -value "Vivado Synthesis Defaults" -objects $obj

# set the current synth run
current_run -synthesis [get_runs synth_1]

# Create 'impl_1' run (if not found)
if {[string equal [get_runs -quiet impl_1] ""]} {
    create_run -name impl_1 -part {{ part }} -flow {Vivado Implementation 2024} -strategy "Vivado Implementation Defaults" -report_strategy {No Reports} -constrset constrs_1 -parent_run synth_1
} else {
  set_property strategy "Vivado Implementation Defaults" [get_runs impl_1]
  set_property flow "Vivado Implementation 2024" [get_runs impl_1]
}
set obj [get_runs impl_1]
set_property -name "auto_incremental_checkpoint" -value "1" -objects $obj
set_property -name "strategy" -value "Vivado Implementation Defaults" -objects $obj
set_property -name "steps.write_bitstream.args.readback_file" -value "0" -objects $obj
set_property -name "steps.write_bitstream.args.verbose" -value "0" -objects $obj

# set the current impl run
current_run -implementation [get_runs impl_1]

puts "INFO: Project created: ${_xil_proj_name_}"
