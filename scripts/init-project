#! /bin/sh

DEST_DIR=${1:-$(pwd)}
DEST_DIR=$(cd "${DEST_DIR}" && pwd)
SVC_TOP=$(cd $(dirname $(readlink -f "$0"))/.. && pwd)

# Guard against running inside svc itself
case "${DEST_DIR}" in
  "${SVC_TOP}"*)
    echo "Error: Cannot run init-project inside svc directory" >&2
    exit 1
    ;;
esac

[ -f "${DEST_DIR}"/flake.nix ] || cp "${SVC_TOP}"/flake.nix "${DEST_DIR}"
[ -f "${DEST_DIR}"/flake.lock ] || cp "${SVC_TOP}"/flake.lock "${DEST_DIR}"
[ -f "${DEST_DIR}"/.envrc ] || cp "${SVC_TOP}"/.envrc "${DEST_DIR}"
[ -f "${DEST_DIR}"/.gitignore ] || cp "${SVC_TOP}"/.gitignore "${DEST_DIR}"

if [ ! -f "${DEST_DIR}"/Makefile ]; then
  cp "${SVC_TOP}"/mk/makefile.template "${DEST_DIR}"/Makefile
fi

mkdir -p "${DEST_DIR}"/rtl
mkdir -p "${DEST_DIR}"/tb

mkdir -p "${DEST_DIR}"/scripts
cd "${DEST_DIR}"/scripts || exit
SCRIPT_REL=$(realpath --relative-to=. "${SVC_TOP}"/scripts)
ln -sf "${SCRIPT_REL}"/* .

cd "${DEST_DIR}" || exit
HOOKS_REL=$(realpath --relative-to=. "${SVC_TOP}"/.githooks)
ln -sf "${HOOKS_REL}" "${DEST_DIR}"

mkdir -p "${DEST_DIR}"/.claude
cd "${DEST_DIR}"/.claude || exit
if [ ! -e skills ]; then
  SKILLS_REL=$(realpath --relative-to=. "${SVC_TOP}"/docs/skills)
  ln -s "${SKILLS_REL}" skills
fi
if [ ! -e commands ]; then
  COMMANDS_REL=$(realpath --relative-to=. "${SVC_TOP}"/.claude/commands)
  ln -s "${COMMANDS_REL}" commands
fi
